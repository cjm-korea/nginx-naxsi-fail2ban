# NAXSI Î™®ÎìàÏùÑ ÎèôÏ†ÅÏúºÎ°ú Î°úÎìúÌï©ÎãàÎã§.
load_module /usr/local/nginx/modules/ngx_http_naxsi_module.so;

# certbot Ïù∏Ï¶ùÏùÑ ÏúÑÌïú ÏµúÏÜåÌïúÏùò Nginx ÏÑ§Ï†ï
worker_processes 1;

events { 
    worker_connections 1024; 
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;

    # üîµ HTTP ÏÑúÎ≤Ñ
    server {
        listen 80 default_server;
        server_name insightone.kr www.insightone.kr;

        # Certbot Ïù∏Ï¶ù ÏöîÏ≤≠Îßå Ï≤òÎ¶¨
        location ^~ /.well-known/acme-challenge/ {
            # Ïù¥ Í≤ΩÎ°úÏùò ÏöîÏ≤≠ÏùÄ Certbot Ïª®ÌÖåÏù¥ÎÑàÏùò ÏõπÎ£®Ìä∏(webroot)Î•º ÏÇ¨Ïö©
            root /var/www/certbot;
        }

        # Í∑∏ Ïô∏ Î™®Îì† HTTP ÏöîÏ≤≠ÏùÄ HTTPSÎ°ú Î¶¨Îã§Ïù¥Î†âÏÖò
        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl http2;
        server_name insightone.kr;

        ssl_certificate     /etc/letsencrypt/live/www.insightone.kr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.insightone.kr/privkey.pem;

        return 301 https://www.insightone.kr$request_uri;
    }

    # üîµ HTTPS ÏÑúÎ≤Ñ (NAXSI ÌôúÏÑ±Ìôî)
    server {
        listen 443 ssl;
        server_name www.insightone.kr;

        ssl_certificate     /etc/letsencrypt/live/www.insightone.kr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/www.insightone.kr/privkey.pem;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        access_log /var/log/nginx/https_access.log;
        error_log  /var/log/nginx/https_error.log;

        # NAXSI
        SecRulesEnabled;
        LearningMode;
        DeniedUrl "/RequestDenied";

        # Î£∞ ÌååÏùº Ìè¨Ìï®(Î≥ºÎ•® ÎßàÏö¥Ìä∏ Í≤ΩÎ°ú Í∏∞Ï§Ä)
        include /etc/nginx/naxsi_core.rules;
        include /etc/nginx/naxsi_whitelist.rules;

        CheckRule "$SQL >= 8" BLOCK;
        CheckRule "$XSS >= 8" BLOCK;
        CheckRule "$TRAVERSAL >= 8" BLOCK;
        CheckRule "$RFI >= 8" BLOCK;
        CheckRule "$EVADE >= 8" BLOCK;
        CheckRule "$UPLOAD >= 8" BLOCK;

        # ÏïÖÏÑ± Í≤ΩÎ°ú Ï∞®Îã®
        location ~* (\.env|wp-login\.php|\.git|\.svn|xmlrpc\.php) {
            return 403;
        }

        location / {
            proxy_pass http://nextjs-app:3000; # Ïª®ÌÖåÏù¥ÎÑà ÎÇ¥Î∂ÄÎ©¥ 'nextjs-app', Ìò∏Ïä§Ìä∏Î©¥ 127.0.0.1
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_intercept_errors on;
            error_page 502 504 500 =404 /notfound;
        }

        # 404 Ìï∏Îì§Îü¨
        location = /notfound {
            return 404;
        }

        location /RequestDenied {
            return 403 "BLOCKED BY NAXSI\n";
        }
    }
}