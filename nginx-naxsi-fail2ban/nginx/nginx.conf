# Local https server config (NAXSI + SSL)
load_module /usr/local/nginx/modules/ngx_http_naxsi_module.so;

worker_processes  1;

events { worker_connections  1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;

    include /etc/nginx/naxsi_core.rules;
    include /etc/nginx/naxsi.rules;
    include /etc/nginx/naxsi_whitelist.rules;

    # ğŸ”µ HTTP â†’ HTTPS ë¦¬ë””ë ‰ì…˜
    server {
        listen 80;
        server_name insightone.kr www.insightone.kr;

        # certbot ì¸ì¦íŒŒì¼ ìœ„ì¹˜
        location ^~ /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # HTTPSë¡œ ë¦¬ë””ë ‰ì…˜
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # ğŸ”µ HTTPS ì„œë²„ (NAXSI í™œì„±í™”)
    server {
        listen 443 ssl;
        server_name insightone.kr www.insightone.kr;

        ssl_certificate     /etc/letsencrypt/live/insightone.kr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/insightone.kr/privkey.pem;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        access_log /var/log/nginx/https_access.log;
        error_log  /var/log/nginx/https_error.log;

        # NAXSI
        SecRulesEnabled;
        DeniedUrl "/RequestDenied";
        CheckRule "$SQL >= 4" BLOCK;
        CheckRule "$XSS >= 4" BLOCK;
        CheckRule "$TRAVERSAL >= 4" BLOCK;
        CheckRule "$RFI >= 4" BLOCK;
        CheckRule "$EVADE >= 4" BLOCK;
        CheckRule "$UPLOAD >= 4" BLOCK;

        # ì•…ì„± ê²½ë¡œ ì°¨ë‹¨
        location ~* (\.env|wp-login\.php|\.git|\.svn|xmlrpc\.php) {
            return 403;
        }

        location / {
            proxy_pass http://nextjs-app:3000; # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ë©´ 'nextjs-app', í˜¸ìŠ¤íŠ¸ë©´ 127.0.0.1
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_intercept_errors on;
            error_page 502 504 500 =404 /notfound;
        }

        # 404 í•¸ë“¤ëŸ¬
        location = /notfound {
            return 404;
        }

        location /RequestDenied {
            return 403 "BLOCKED BY NAXSI\n";
        }
    }
}

# # Local http server test configuration
# load_module /usr/local/nginx/modules/ngx_http_naxsi_module.so;

# worker_processes  1;

# events { worker_connections  1024; }

# http {
#     include       mime.types;
#     default_type  application/octet-stream;

#     include /etc/nginx/naxsi_core.rules;
#     include /etc/nginx/naxsi.rules;
#     include /etc/nginx/naxsi_whitelist.rules;

#     server {
#         listen 80;
#         server_name 127.0.0.1 localhost;

#         access_log /var/log/nginx/https_access.log;
#         error_log  /var/log/nginx/https_error.log;

#         # naxsi í™œì„±í™”
#         SecRulesEnabled;
#         DeniedUrl "/RequestDenied";
#         CheckRule "$SQL >= 4" BLOCK;
#         CheckRule "$XSS >= 4" BLOCK;
#         CheckRule "$TRAVERSAL >= 4" BLOCK;
#         CheckRule "$RFI >= 4" BLOCK;
#         CheckRule "$EVADE >= 4" BLOCK;
#         CheckRule "$UPLOAD >= 4" BLOCK;

#         # âœ… ì•…ì„± ê²½ë¡œ ì§ì ‘ ì°¨ë‹¨ (403)
#         location ~* (\.env|wp-login\.php|\.git|\.svn|xmlrpc\.php) {
#             return 403;
#         }

#         location / {
#             proxy_pass http://127.0.0.1:3000;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;

#             # ë°±ì—”ë“œê°€ ì—†ì„ ë•Œ 404ë¡œ ëŒ€ì²´
#             proxy_intercept_errors on;
#             error_page 502 504 500 =404 /notfound;
#         }

#         # 404 í˜ì´ì§€ í•¸ë“¤ëŸ¬
#         location = /notfound {
#             return 404;
#         }

#         location /RequestDenied {
#             return 403 "BLOCKED BY NAXSI\n";
#         }
#     }
# }