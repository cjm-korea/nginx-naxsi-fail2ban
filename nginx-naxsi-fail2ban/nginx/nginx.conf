# Local https server config (NAXSI + SSL)
load_module /usr/local/nginx/modules/ngx_http_naxsi_module.so;

worker_processes  1;

events { worker_connections  1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;

    include /etc/nginx/naxsi_core.rules;
    include /etc/nginx/naxsi.rules;
    include /etc/nginx/naxsi_whitelist.rules;

    # 🔵 HTTP → HTTPS 리디렉션
    server {
        listen 80;
        server_name insightone.kr www.insightone.kr;

        # certbot 인증파일 위치
        location ^~ /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # HTTPS로 리디렉션
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # 🔵 HTTPS 서버 (NAXSI 활성화)
    server {
        listen 443 ssl;
        server_name insightone.kr www.insightone.kr;

        ssl_certificate     /etc/letsencrypt/live/insightone.kr/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/insightone.kr/privkey.pem;
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_ciphers         HIGH:!aNULL:!MD5;

        access_log /var/log/nginx/https_access.log;
        error_log  /var/log/nginx/https_error.log;

        # NAXSI
        SecRulesEnabled;
        DeniedUrl "/RequestDenied";
        CheckRule "$SQL >= 4" BLOCK;
        CheckRule "$XSS >= 4" BLOCK;
        CheckRule "$TRAVERSAL >= 4" BLOCK;
        CheckRule "$RFI >= 4" BLOCK;
        CheckRule "$EVADE >= 4" BLOCK;
        CheckRule "$UPLOAD >= 4" BLOCK;

        # 악성 경로 차단
        location ~* (\.env|wp-login\.php|\.git|\.svn|xmlrpc\.php) {
            return 403;
        }

        location / {
            proxy_pass http://nextjs-app:3000; # 컨테이너 내부면 'nextjs-app', 호스트면 127.0.0.1
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_intercept_errors on;
            error_page 502 504 500 =404 /notfound;
        }

        # 404 핸들러
        location = /notfound {
            return 404;
        }

        location /RequestDenied {
            return 403 "BLOCKED BY NAXSI\n";
        }
    }
}

# # Local http server test configuration
# load_module /usr/local/nginx/modules/ngx_http_naxsi_module.so;

# worker_processes  1;

# events { worker_connections  1024; }

# http {
#     include       mime.types;
#     default_type  application/octet-stream;

#     include /etc/nginx/naxsi_core.rules;
#     include /etc/nginx/naxsi.rules;
#     include /etc/nginx/naxsi_whitelist.rules;

#     server {
#         listen 80;
#         server_name 127.0.0.1 localhost;

#         access_log /var/log/nginx/https_access.log;
#         error_log  /var/log/nginx/https_error.log;

#         # naxsi 활성화
#         SecRulesEnabled;
#         DeniedUrl "/RequestDenied";
#         CheckRule "$SQL >= 4" BLOCK;
#         CheckRule "$XSS >= 4" BLOCK;
#         CheckRule "$TRAVERSAL >= 4" BLOCK;
#         CheckRule "$RFI >= 4" BLOCK;
#         CheckRule "$EVADE >= 4" BLOCK;
#         CheckRule "$UPLOAD >= 4" BLOCK;

#         # ✅ 악성 경로 직접 차단 (403)
#         location ~* (\.env|wp-login\.php|\.git|\.svn|xmlrpc\.php) {
#             return 403;
#         }

#         location / {
#             proxy_pass http://127.0.0.1:3000;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;

#             # 백엔드가 없을 때 404로 대체
#             proxy_intercept_errors on;
#             error_page 502 504 500 =404 /notfound;
#         }

#         # 404 페이지 핸들러
#         location = /notfound {
#             return 404;
#         }

#         location /RequestDenied {
#             return 403 "BLOCKED BY NAXSI\n";
#         }
#     }
# }